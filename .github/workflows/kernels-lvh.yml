name: Test MCPSpy across various Linux Kernels with LVH

on:
  push:
    branches: [eBPF-kernels]
  pull_request:
    branches: [eBPF-kernels]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # Ensure that only one job runs at a time for this workflow
  cancel-in-progress: true

jobs:
  e2e-build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm make libbpf-dev build-essential

      - name: Install Go tools
        run: go install github.com/cilium/ebpf/cmd/bpf2go@latest

      - name: Download dependencies
        run: go mod download

      - name: Build MCPSpy
        run: make build

      - name: Upload MCPSpy binary
        uses: actions/upload-artifact@v4
        with:
          name: mcpspy-binary
          path: build/mcpspy-linux-amd64

  e2e-kernel-tests:
    needs: e2e-build
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false # Continue running all jobs even if one fails
      matrix:
        # List of kernel versions to test against
        # Find available tags here: https://quay.io/repository/lvh-images/kind?tab=tags
        kernel:
#           - "6.6-20250616.013250-amd64"
#           - "5.15-20250616.013250-amd64"
          - "5.10-main-amd64"
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download MCPSpy binary
        uses: actions/download-artifact@v4
        with:
          name: mcpspy-binary

      - name: Provision LVH VMs
        uses: cilium/little-vm-helper@v0.0.26
        with:
          test-name: mcpspy-test-${{ matrix.kernel }}
          image: "kind" # Available options: kind, complexity-test, base (needs authentication)
          image-version: ${{ matrix.kernel }} # Pull the specific kernel version for testing
          host-mount: . # Mount the current workspace into the VM
          install-dependencies: "true"
          cmd: |
            # Print the kernel version of the test VM
            echo "Kernel Version: "
            uname -a

            # goto where host is mounted
            cd /host
            ls -lah

            # make test-e2e-setup

            # echo "Running MCPSpy tests on LVH VM with kernel ${{ matrix.kernel }}"
            # sudo -E tests/venv/bin/python tests/e2e_test.py --mcpspy build/mcpspy-linux-amd64
